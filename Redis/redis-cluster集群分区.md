### 转载于[你不知道的Redis：RedisCluster与JedisCluster](https://juejin.cn/post/6844903870666113031#heading-2)
[Redis Cluster分区实现原理](https://my.oschina.net/andylucc/blog/704440)
#### redis cluster 集群分区
1. Redis Cluster 是去中心化的，它将所有数据分区存储，每个节点只负责自己应该管理的那部分数据，相互之间存储的数据是不同的  
2. Redis Cluster 将全部的键空间划分为 16384 块（该数值是初始设置的），每一块空间称之为槽（slot）
#### 位序列结构，bit数组标识
Master节点维护着一个16384/8字节的位序列，Master节点用bit来标识对于某个槽自己是否拥有。比如对于编号为1的槽，Master只要判断序列的第二位（索引从0开始）是不是为1即可
#### 键哈希标签原理
>1. 键哈希标签是一种可以让用户指定将一批键都能够被存放在同一个槽中的实现方法
>2. 用户唯一要做的就是按照<B>既定规则</B>生成key即可，这个规则是这样的，如果我有对于同一个用户有两种不同含义的两份数据
>3. 计算槽编号的时候只会获取{}之间的字符串进行槽编号计算,这样由于上面两个不同的键，{}里面的字符串是相同的，因此他们可以被计算出相同的槽
#### 常见的数据分区方法：
>+ 节点取余分区：对特定数据取hash值再对节点数取余来决定映射到哪一个节点。优点是简单，缺点是扩容或收缩时需重新计算映射结果，极端情况下会导致数据全量迁移。
>+ 一致性哈希分区：给每个节点分配一个0～2^32的token，使其构成一个环，数据命中规则为根据key的hash值，顺时针找到第一个token大于等于该hash的节点。优点是加减节点只影响相邻的节点，缺点是节点少的时候优点变缺点，反倒会影响环中大部分数据，同时加减节点时候会导致部分数据无法命中。
>+ 虚拟槽分区：使用分散度良好的hash函数将数据映射到一个固定范围的整数集合，这些整数便是槽位，再分给具体的节点管理。Redis Cluster使用的便是虚拟槽分区

#### redis-cluster 集群模式下的读写
>1. 采用了直接节点的方式。集群模式下，客户端去操作集群是直连到一个具体的节点上操作的。当该节点接收到任何键操作命令时，会先计算键对应的slot，然后根据slot找出对应节点（这里如何找后面会提到），
>2. 如果对应的节点是自身，则执行键操作命令，返回结果；
>3. 如果不是自身，会返回给客户端MOVED重定向错误，告诉客户端应该请求具体哪个节点，由客户端发起二次请求到正确的节点，完成本次键操作。


### 被除数为2的n次幂的取余，可以用位运算做  
> 设X对Y求余，Y等于2^N，相当于左移N位，被移掉的N位便是余数，只要保留这N位即可    
> 与 1 的按位与，可以保留原始值，只要保证前 N 为前为 0 ，后 N 位 全为1，即可，可见，该值为 2^N - 1  
> 即 X % （z^N）= X & (2^N - 1)  
> 参考于 [二进制按位与&及求余数](https://perkins4j2.github.io/posts/19120/)
